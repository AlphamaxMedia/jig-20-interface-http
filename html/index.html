<!DOCTYPE html>
<html lang="en">
<head>
    <script
            src="/jquery-3.1.1.js"
            integrity="sha256-16cdPddA6VdVInumRGo6IbivbERE8p7CQR3HzTBuELA="
            crossorigin="anonymous"></script>
    <meta charset="utf-8">
</head>
<body>
    <script>
        function updateStuff(result) {
            $("#serverid").html(result.server);

            $("#jigid").html(result.jig);
            $("#jigname").html(result.jig_name);
            $("#jigdescription").html(result.jig_description);

            $("#scenarioid").html(result.scenario);
            $("#scenarioname").html(result.scenario_names[result.scenario]);
            $("#scenariodescription").html(result.scenario_descriptions[result.scenario]);

            var selected_id = $('#scenarioselect').val() || result.scenario;
            $("#scenarioselect").empty();
            result.scenarios.forEach(function(e) {
                $("#scenarioselect").append($('<option>', {
                    value: e,
                    selected: e == selected_id
                }).text(result.scenario_names[e]));
            });

            $("#logs").find('tbody').empty();
            result.log.forEach(function(e) {
                d = new Date(0);
                d.setUTCSeconds(e.timestamp.secs);
                d.setMilliseconds(e.timestamp.nanos / 1000000);
                $("#logs").find('tbody')
                    .append($('<tr>')
                        .append($('<td>').text(e.message_type))
                        .append($('<td>').text(e.unit_type))
                        .append($('<td>').text(e.unit_id))
                        .append($('<td>').text(d))
                        .append($('<td>').text(e.message))
                    );
            });

            queueUpdate(500);
        }
        function queueUpdate(timeout) {
            window.setTimeout(function() { fireUpdate(); }, timeout);
        }
        function fireUpdate() {
            $.ajax({url: "/current.json", success: updateStuff});
        }
        function changeScenario(e) {
            var new_scenario_id = $('#scenarioselect').val();
            console.log("Changed scenario to " + new_scenario_id);
            $.ajax({url: "/scenario?" + new_scenario_id, success: function(){}});
            return true;
        }

        $(document).ready(function() {
            $('#scenarioselect').on("change", changeScenario);
            fireUpdate();
        })
    </script>
    <ol>
        <li><a href="/exit">Quit Server</a></li>
    </ol>
    <div>Server ID: <span id="serverid"></span></div>
    <section id="jigsection">
        <div>Jig: <span id="jigid"></span></div>
        <div>Jig name: <span id="jigname"></span></div>
        <div>Jig description: <span id="jigdescription"></span></div>
    </section>
    <section id="scenariosection">
        <div>Scenario: <span id="scenarioid"></span></div>
        <div>Scenario name: <span id="scenarioname"></span></div>
        <div>Scenario description: <span id="scenariodescription"></span></div>
    </section>
    <section id="testsection">
        <div>Test: <span id="testid"></span></div>
        <div>Test name: <span id="testname"></span></div>
        <div>Test description: <span id="testdescription"></span></div>
    </section>
    <section id="scenariolist"><label for="scenarioselect">Available Scenarios</label>
        <select name="scenarioselect" id="scenarioselect" size="5">
        </select>
    </section>
    <table id="logs">
        <thead>
            <tr>
                <th>Type</th>
                <th>Unit Type</th>
                <th>Unit ID</th>
                <th>Timestamp</th>
                <th>Message</th>
            </tr>
        </thead>
        <tbody>
            <tr></tr>
        </tbody>
    </table>
</body>
</html>